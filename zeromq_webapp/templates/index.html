<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Market Quotes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <table id="quotes">
      <thead>
        <tr>
          <th>Local Symbol</th>
          <th>Bid Price</th>
          <th>Ask Price</th>
          <th>Spread</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="diffChart" width="800" height="400"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const diffData = {
        labels: [],
        datasets: [
          { label: 'Bid', data: [], borderColor: 'green', fill: false },
          { label: 'Ask', data: [], borderColor: 'red', fill: false },
          { label: 'Bid-PrevAsk', data: [], borderColor: 'blue', fill: false }
        ]
      };
      const monthOrder = { F:1, G:2, H:3, J:4, K:5, M:6, N:7, Q:8, U:9, V:10, X:11, Z:12 };
      const selectedSymbols = new Set();
      let lastDiffLabel = '';
      let lastDiffAsk = null;

      function selectSymbolPair(rowMap) {
        const symbols = Array.from(selectedSymbols);
        if (symbols.includes('F_XAUUSD1025') && symbols.includes('F_XAUUSD1225')) {
          const laterRow = rowMap['F_XAUUSD1225'];
          const earlierRow = rowMap['F_XAUUSD1025'];
          if (laterRow && earlierRow) {
            return {
              later: { row: laterRow },
              earlier: { row: earlierRow },
              label: 'F_XAUUSD1025_1225_DIFF'
            };
          }
        }
        if (symbols.length < 2) return null;
        function parse(sym) {
          const row = rowMap[sym];
          if (!row) return null;
          const m = sym.match(/^([A-Z]+)([FGHJKMNQUVXZ])(\d+)/);
          if (!m) return null;
          const [, root, month, year] = m;
          const order = parseInt(year, 10) * 12 + monthOrder[month];
          return { root, suffix: month + year, order, row };
        }
        for (let i = 0; i < symbols.length; i++) {
          const p1 = parse(symbols[i]);
          if (!p1) continue;
          for (let j = i + 1; j < symbols.length; j++) {
            const p2 = parse(symbols[j]);
            if (!p2 || p1.root !== p2.root) continue;
            let later = p1, earlier = p2;
            if (p2.order > p1.order) { later = p2; earlier = p1; }
            if (parseFloat(later.row.askprice) > parseFloat(earlier.row.askprice)) {
              return { later, earlier };
            }
          }
        }
        return null;
      }
      const diffChartCtx = document.getElementById('diffChart').getContext('2d');
      const diffChart = new Chart(diffChartCtx, {
        type: 'line',
        data: diffData,
        options: { scales: { x: { display: true }, y: { display: true } } }
      });

      function update() {
        fetch('/data')
          .then(response => response.json())
          .then(rows => {
            const tbody = document.querySelector('#quotes tbody');
            tbody.innerHTML = '';
            const rowMap = {};
            rows.forEach(r => rowMap[r.local_symbol] = r);
            for (const sym of Array.from(selectedSymbols)) {
              if (!rowMap[sym]) selectedSymbols.delete(sym);
            }
            const pair = selectSymbolPair(rowMap);
            if (pair) {
              const later = pair.later.row;
              const earlier = pair.earlier.row;
              const diffBid = parseFloat(later.bidprice) - parseFloat(earlier.askprice);
              const diffAsk = parseFloat(later.askprice) - parseFloat(earlier.bidprice);
              let crossSpread = null;
              if (lastDiffAsk !== null && diffBid > lastDiffAsk) {
                crossSpread = diffBid - lastDiffAsk;
              }
              lastDiffAsk = diffAsk;
              const time = later.time || earlier.time;
              const symbolLabel = pair.label || `DIFF-${pair.later.suffix}-${pair.earlier.suffix}`;
              const diffRow = {
                local_symbol: symbolLabel,
                bidprice: diffBid.toFixed(2),
                askprice: diffAsk.toFixed(2),
                time: time,
                synthetic: true,
                cross: crossSpread
              };
              rows.push(diffRow);
              if (symbolLabel !== lastDiffLabel) {
                lastDiffLabel = symbolLabel;
                diffData.labels = [];
                diffData.datasets[0].data = [];
                diffData.datasets[1].data = [];
                diffData.datasets[2].data = [];
                lastDiffAsk = null;
              }
              diffData.labels.push(time);
              diffData.datasets[0].label = `Bid ${symbolLabel}`;
              diffData.datasets[1].label = `Ask ${symbolLabel}`;
              diffData.datasets[2].label = `Bid-PrevAsk ${symbolLabel}`;
              diffData.datasets[0].data.push(diffBid);
              diffData.datasets[1].data.push(diffAsk);
              diffData.datasets[2].data.push(crossSpread);
              if (diffData.labels.length > 100) {
                diffData.labels.shift();
                diffData.datasets[0].data.shift();
                diffData.datasets[1].data.shift();
                diffData.datasets[2].data.shift();
              }
              diffChart.update();
            }
            rows.forEach(row => {
              let spread = Math.abs(parseFloat(row.askprice) - parseFloat(row.bidprice));
              if (row.synthetic && row.cross !== null) {
                spread = row.cross;
              }
              row.spread = spread.toFixed(2);
              const tr = document.createElement('tr');
              ['local_symbol','bidprice','askprice','spread','time'].forEach(col => {
                const td = document.createElement('td');
                if (col === 'local_symbol' && !row.synthetic) {
                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.checked = selectedSymbols.has(row[col]);
                  checkbox.addEventListener('change', e => {
                    if (e.target.checked) selectedSymbols.add(row[col]);
                    else selectedSymbols.delete(row[col]);
                  });
                  td.appendChild(checkbox);
                  td.appendChild(document.createTextNode(' ' + row[col]));
                } else {
                  td.textContent = row[col];
                  if (col === 'bidprice' || col === 'askprice' || col === 'spread') {
                    td.className = parseFloat(row[col]) >= 0 ? 'green' : 'red';
                  }
                }
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
          });
      }
      setInterval(update, 1000);
      update();
    </script>
  </body>
</html>
